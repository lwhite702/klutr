module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},81579,67409,95238,e=>{"use strict";var t=e.i(67652);let r={note:{async create(e){let r=e.data,{data:a,error:s}=await t.supabaseAdmin.from("notes").insert({user_id:r.userId,content:r.content,type:r.type||"unclassified",archived:r.archived||!1}).select().single();if(s)throw s;let n=[];if(e.include?.tags){let{data:e}=await t.supabaseAdmin.from("note_tags").select("tag_id, tags(*)").eq("note_id",a.id);n=e?.map(e=>({tagId:e.tag_id,tag:e.tags}))||[]}return{...a,userId:a.user_id,createdAt:a.created_at,updatedAt:a.updated_at,clusterConfidence:a.cluster_confidence,clusterUpdatedAt:a.cluster_updated_at,tags:n}},async findMany(e){let r="*";if(e.select){let t=[];for(let r in e.select)if(e.select[r]){let e="userId"===r?"user_id":r;t.push(e)}r=t.join(", ")}let a=t.supabaseAdmin.from("notes").select(r);if(e.where?.userId&&(a=a.eq("user_id",e.where.userId)),e.where?.type&&(a=a.eq("type",e.where.type)),e.where?.cluster!==void 0&&(a=null===e.where.cluster?a.is("cluster",null):"object"==typeof e.where.cluster&&null!==e.where.cluster&&"not"in e.where.cluster&&null===e.where.cluster.not?a.not("cluster","is",null):a.eq("cluster",e.where.cluster)),e.where?.archived!==void 0&&(a=a.eq("archived",e.where.archived)),e.where?.createdAt?.gte&&(a=a.gte("created_at",e.where.createdAt.gte.toISOString())),e.where?.createdAt?.lt&&(a=a.lt("created_at",e.where.createdAt.lt.toISOString())),e.where?.embedding===null&&(a=a.is("embedding",null)),e.where?.OR&&e.where.OR.length>0){let t=e.where.OR.map(e=>e.type?`type.eq.${e.type}`:void 0!==e.archived?`archived.eq.${e.archived}`:null).filter(Boolean);t.length>0&&(a=a.or(t.join(",")))}e.orderBy?.createdAt&&(a=a.order("created_at",{ascending:"asc"===e.orderBy.createdAt})),e.take&&(a=a.limit(e.take));let{data:s,error:n}=await a;if(n)throw n;return e.include?.tags?await Promise.all((s||[]).map(async e=>{let{data:r}=await t.supabaseAdmin.from("note_tags").select("tag_id, tags(*)").eq("note_id",e.id),a=r?.map(e=>({tagId:e.tag_id,tag:e.tags}))||[];return{...e,userId:e.user_id,createdAt:e.created_at,updatedAt:e.updated_at,clusterConfidence:e.cluster_confidence,clusterUpdatedAt:e.cluster_updated_at,tags:a}})):(s||[]).map(t=>{let r={...t};if(void 0!==t.user_id&&(r.userId=t.user_id),void 0!==t.created_at&&(r.createdAt=t.created_at),void 0!==t.updated_at&&(r.updatedAt=t.updated_at),void 0!==t.cluster_confidence&&(r.clusterConfidence=t.cluster_confidence),void 0!==t.cluster_updated_at&&(r.clusterUpdatedAt=t.cluster_updated_at),e.select){let t={};for(let a in e.select)e.select[a]&&(t[a]=r[a]||r["userId"===a?"user_id":a]);return t}return r})},async findUnique(e){let{data:r,error:a}=await t.supabaseAdmin.from("notes").select("*").eq("id",e.where.id).single();if(a)throw a;if(e.select){let t={};for(let a in e.select)e.select[a]&&r[a]&&(t[a]=r[a]);return void 0!==t.user_id&&(t.userId=t.user_id,delete t.user_id),t}return{...r,userId:r.user_id,createdAt:r.created_at,updatedAt:r.updated_at,clusterConfidence:r.cluster_confidence,clusterUpdatedAt:r.cluster_updated_at}},async findFirst(e){let r=t.supabaseAdmin.from("notes").select("*").limit(1);e.where.userId&&(r=r.eq("user_id",e.where.userId)),e.where.cluster&&(r=r.eq("cluster",e.where.cluster));let{data:a,error:s}=await r;if(s)throw s;return a?.[0]||null},async update(e){let r={};void 0!==e.data.type&&(r.type=e.data.type),void 0!==e.data.archived&&(r.archived=e.data.archived),void 0!==e.data.cluster&&(r.cluster=e.data.cluster),void 0!==e.data.clusterConfidence&&(r.cluster_confidence=e.data.clusterConfidence),void 0!==e.data.clusterUpdatedAt&&(r.cluster_updated_at=e.data.clusterUpdatedAt?.toISOString());let{data:a,error:s}=await t.supabaseAdmin.from("notes").update(r).eq("id",e.where.id).select().single();if(s)throw s;if(e.data.tags?.create)for(let r of e.data.tags.create)await t.supabaseAdmin.from("note_tags").insert({note_id:e.where.id,tag_id:r.tagId});let n=[];if(e.include?.tags){let{data:r}=await t.supabaseAdmin.from("note_tags").select("tag_id, tags(*)").eq("note_id",e.where.id);n=r?.map(e=>({tagId:e.tag_id,tag:e.tags}))||[]}return{...a,userId:a.user_id,createdAt:a.created_at,updatedAt:a.updated_at,clusterConfidence:a.cluster_confidence,clusterUpdatedAt:a.cluster_updated_at,tags:n}},async groupBy(e){let t=await this.findMany({where:{userId:e.where?.userId,cluster:e.where?.cluster===null?null:void 0,archived:e.where?.archived}}),r=new Map;for(let e of t){let t=e.cluster||"null";r.set(t,(r.get(t)||0)+1)}return Array.from(r.entries()).map(([e,t])=>({cluster:"null"===e?null:e,_count:{id:t}}))},async $executeRaw(e,...r){let a=e.join("?");if(a.includes("UPDATE notes")&&a.includes("embedding")){let e,a=r[0],s=r[1]||r[r.length-1];if(Array.isArray(a))e=a;else if("string"==typeof a)try{e=JSON.parse(a)}catch{e=a.split(",").map(Number)}else throw Error("Invalid embedding format");let{error:n}=await t.supabaseAdmin.rpc("update_note_embedding",{note_id_param:s,embedding_param:`[${e.join(",")}]`});if(n){console.error("RPC embedding update error:",n);let{error:r}=await t.supabaseAdmin.from("notes").update({embedding:e}).eq("id",s);if(r)throw r}return Promise.resolve()}return console.warn("Raw SQL execution not fully supported. Use RPC functions instead."),Promise.resolve()}},tag:{async upsert(e){let{data:r}=await t.supabaseAdmin.from("tags").select("id").eq("user_id",e.where.userId_name.userId).eq("name",e.where.userId_name.name).single();if(r)return r;let{data:a,error:s}=await t.supabaseAdmin.from("tags").insert({user_id:e.create.userId,name:e.create.name}).select().single();if(s)throw s;return a}},noteTag:{async deleteMany(e){let{error:r}=await t.supabaseAdmin.from("note_tags").delete().eq("note_id",e.where.noteId);if(r)throw r;return{count:0}}},smartStack:{async findMany(e){let r=t.supabaseAdmin.from("smart_stacks").select("*");e?.where?.userId&&(r=r.eq("user_id",e.where.userId)),e?.orderBy?.noteCount&&(r=r.order("note_count",{ascending:"asc"===e.orderBy.noteCount}));let{data:a,error:s}=await r;if(s)throw s;return(a||[]).map(e=>({...e,userId:e.user_id,noteCount:e.note_count,createdAt:e.created_at,updatedAt:e.updated_at}))},async findFirst(e){let{data:r,error:a}=await t.supabaseAdmin.from("smart_stacks").select("*").eq("user_id",e.where.userId).eq("cluster",e.where.cluster).limit(1).maybeSingle();if(a)throw a;return r},async upsert(e){let r=null;if("id"in e.where){let{data:a}=await t.supabaseAdmin.from("smart_stacks").select("*").eq("id",e.where.id).maybeSingle();r=a}else if("userId_name"in e.where){let{data:a}=await t.supabaseAdmin.from("smart_stacks").select("*").eq("user_id",e.where.userId_name.userId).eq("name",e.where.userId_name.name).maybeSingle();r=a}if(r){let a=e.where.id||r.id,{data:s,error:n}=await t.supabaseAdmin.from("smart_stacks").update({note_count:e.update.noteCount,summary:e.update.summary}).eq("id",a).select().single();if(n)throw n;return{...s,userId:s.user_id,noteCount:s.note_count,createdAt:s.created_at,updatedAt:s.updated_at}}{let a=r?.cluster||e.create.cluster||"Misc",{data:s,error:n}=await t.supabaseAdmin.from("smart_stacks").insert({user_id:e.create.userId,name:e.create.name,cluster:a,note_count:e.create.noteCount||0,summary:e.create.summary||"",pinned:e.create.pinned||!1}).select().single();if(n)throw n;return{...s,userId:s.user_id,noteCount:s.note_count,createdAt:s.created_at,updatedAt:s.updated_at}}}},vaultNote:{async create(e){let r=e.data,{data:a,error:s}=await t.supabaseAdmin.from("vault_notes").insert({user_id:r.userId,encrypted_blob:r.encryptedBlob}).select().single();if(s)throw s;return a},async findMany(e){let r=t.supabaseAdmin.from("vault_notes").select("*").eq("user_id",e.where.userId);if(e.select){let t=[];for(let r in e.select)if(e.select[r]){let e="createdAt"===r?"created_at":r;t.push(e)}t.length>0&&(r=r.select(t.join(", ")))}e.orderBy?.createdAt&&(r=r.order("created_at",{ascending:"asc"===e.orderBy.createdAt}));let{data:a,error:s}=await r;if(s)throw s;return(a||[]).map(t=>{let r={};if(e.select){for(let a in e.select)if(e.select[a]){let e="createdAt"===a?"created_at":a;r[a]=t[e]}}else r.id=t.id,r.createdAt=t.created_at?new Date(t.created_at):t.created_at,r.userId=t.user_id,r.encryptedBlob=t.encrypted_blob;return r})}},weeklyInsight:{async findMany(e){let r=t.supabaseAdmin.from("weekly_insights").select("*");e?.where?.userId&&(r=r.eq("user_id",e.where.userId)),e?.orderBy?.weekStart&&(r=r.order("week_start",{ascending:"asc"===e.orderBy.weekStart})),e?.take&&(r=r.limit(e.take));let{data:a,error:s}=await r;if(s)throw s;return(a||[]).map(e=>({...e,userId:e.user_id,weekStart:new Date(e.week_start),noteCount:e.note_count,createdAt:new Date(e.created_at)}))},async findFirst(e){let r=t.supabaseAdmin.from("weekly_insights").select("*").eq("user_id",e.where.userId).limit(1);e.where.weekStart&&(r=r.eq("week_start",e.where.weekStart.toISOString())),e.orderBy?.weekStart&&(r=r.order("week_start",{ascending:"asc"===e.orderBy.weekStart}));let{data:a,error:s}=await r;if(s)throw s;if(!a||0===a.length)return null;let n=a[0];return{...n,userId:n.user_id,weekStart:new Date(n.week_start),noteCount:n.note_count,createdAt:new Date(n.created_at)}},async upsert(e){let{data:r}=await t.supabaseAdmin.from("weekly_insights").select("*").eq("user_id",e.where.userId_weekStart.userId).eq("week_start",e.where.userId_weekStart.weekStart.toISOString()).maybeSingle();if(r){let{data:a,error:s}=await t.supabaseAdmin.from("weekly_insights").update({summary:e.update.summary,sentiment:e.update.sentiment,note_count:e.update.noteCount}).eq("id",r.id).select().single();if(s)throw s;return a}{let{data:r,error:a}=await t.supabaseAdmin.from("weekly_insights").insert({user_id:e.create.userId,week_start:e.create.weekStart.toISOString(),summary:e.create.summary,sentiment:e.create.sentiment,note_count:e.create.noteCount}).select().single();if(a)throw a;return r}},async update(e){let{data:r,error:a}=await t.supabaseAdmin.from("weekly_insights").update({...void 0!==e.data.summary&&{summary:e.data.summary},...void 0!==e.data.sentiment&&{sentiment:e.data.sentiment},...void 0!==e.data.noteCount&&{note_count:e.data.noteCount}}).eq("id",e.where.id).select().single();if(a)throw a;return{...r,userId:r.user_id,weekStart:new Date(r.week_start),noteCount:r.note_count,createdAt:new Date(r.created_at)}},async create(e){let{data:r,error:a}=await t.supabaseAdmin.from("weekly_insights").insert({user_id:e.data.userId,week_start:e.data.weekStart.toISOString(),summary:e.data.summary,sentiment:e.data.sentiment,note_count:e.data.noteCount}).select().single();if(a)throw a;return{...r,userId:r.user_id,weekStart:new Date(r.week_start),noteCount:r.note_count,createdAt:new Date(r.created_at)}}},user:{async findMany(e){let{data:r,error:a}=await t.supabaseAdmin.from("users").select(e?.select?.id!==!1?"id":"").select(e?.select?.email!==!1?"email":"");if(a)throw a;return r?.map(e=>({id:e.id,email:e.email}))||[]}}};async function a(e){return console.warn("$queryRaw not fully supported in Supabase adapter"),Promise.resolve([])}async function s(e,...t){return r.note.$executeRaw(e,...t)}({...r,$queryRaw:a,$executeRaw:s}),e.s(["db",0,r,"isDatabaseAvailable",0,()=>!0],67409),e.s([],81579),e.s(["prisma",0,r],95238)},21143,e=>{"use strict";var t=e.i(94792);let r=new Map;function a(e){return t=>{let a=e.keyGenerator?e.keyGenerator(t):t.headers.get("x-forwarded-for")||t.headers.get("x-real-ip")||"anonymous",s=Date.now();for(let[t,a]of(e.windowMs,r.entries()))a.resetTime<s&&r.delete(t);let n=r.get(a);return!n||n.resetTime<s?(r.set(a,{count:1,resetTime:s+e.windowMs}),!0):!(n.count>=e.limit)&&(n.count++,!0)}}function s(e,r=400,a){return t.NextResponse.json({error:e,code:a,timestamp:new Date().toISOString()},{status:r})}function n(e,r){if(r){let a=r.safeParse(e);return a.success?t.NextResponse.json(a.data):(console.error("Response validation failed:",a.error),s("Invalid response format",500,"RESPONSE_VALIDATION_ERROR"))}return t.NextResponse.json(e)}function i(e,t){return async r=>a(e)(r)?t(r):s("Rate limit exceeded. Please try again later.",429,"RATE_LIMIT_EXCEEDED")}function o(e,t,r){return async n=>{let i;if(!a(t)(n))return s("Rate limit exceeded. Please try again later.",429,"RATE_LIMIT_EXCEEDED");try{i=await n.json()}catch(e){return s("Invalid JSON in request body",400,"INVALID_JSON")}let o=function(e,t){try{let r=e.safeParse(t);if(r.success)return{success:!0,data:r.data};return{success:!1,error:r.error.errors.map(e=>`${e.path.join(".")}: ${e.message}`).join(", ")}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown validation error"}}}(e,i);return o.success?r(n,o.data):s(`Validation failed: ${o.error}`,400,"VALIDATION_ERROR")}}e.s(["RATE_LIMITS",0,{GENERAL:{limit:100,windowMs:9e5},CREATE_NOTE:{limit:20,windowMs:9e5},AI_OPERATIONS:{limit:5,windowMs:9e5},VAULT_OPERATIONS:{limit:10,windowMs:9e5},RECLUSTER:{limit:3,windowMs:36e5}},"createErrorResponse",()=>s,"createSuccessResponse",()=>n,"withRateLimit",()=>i,"withValidationAndRateLimit",()=>o])},96391,e=>{"use strict";var t=e.i(94792);let r={defaultSrc:["'self'"],scriptSrc:["'self'","'unsafe-inline'","'unsafe-eval'"],styleSrc:["'self'","'unsafe-inline'","https://fonts.googleapis.com"],imgSrc:["'self'","data:","https:","blob:"],connectSrc:["'self'","https://api.openai.com","https://api.anthropic.com","wss:","ws:"],fontSrc:["'self'","https://fonts.gstatic.com","data:"],objectSrc:["'none'"],mediaSrc:["'self'"],frameSrc:["'none'"],workerSrc:["'self'"],manifestSrc:["'self'"],formAction:["'self'"],frameAncestors:["'none'"],baseUri:["'self'"],upgradeInsecureRequests:!0,blockAllMixedContent:!0};function a(e){let t,a=(t=[],Object.entries(r).forEach(([e,r])=>{if(void 0===r)return;let a=e.replace(/([A-Z])/g,"-$1").toLowerCase();"boolean"==typeof r?r&&t.push(a):Array.isArray(r)&&r.length>0&&t.push(`${a} ${r.join(" ")}`)}),t.join("; "));return e.headers.set("Content-Security-Policy",a),e.headers.set("X-Frame-Options","DENY"),e.headers.set("X-Content-Type-Options","nosniff"),e.headers.set("Referrer-Policy","strict-origin-when-cross-origin"),e.headers.set("Permissions-Policy","camera=(), microphone=(), geolocation=()"),e.headers.set("Strict-Transport-Security","max-age=31536000; includeSubDomains"),e}function s(e,r=400,n){return a(t.NextResponse.json({error:e,code:n,timestamp:new Date().toISOString()},{status:r}))}function n(e,r){let s;if(r){let a=r.safeParse(e);a.success?s=t.NextResponse.json(a.data):(console.error("Response validation failed:",a.error),s=t.NextResponse.json({error:"Invalid response format",code:"RESPONSE_VALIDATION_ERROR",timestamp:new Date().toISOString()},{status:500}))}else s=t.NextResponse.json(e);return a(s)}({...r,scriptSrc:["'self'","'unsafe-inline'","'unsafe-eval'","http://localhost:*","ws://localhost:*"],connectSrc:["'self'","http://localhost:*","ws://localhost:*","wss://localhost:*","https://api.openai.com","https://api.anthropic.com"]}),e.s(["createSecureErrorResponse",()=>s,"createSecureSuccessResponse",()=>n])},87515,e=>{"use strict";var t=e.i(40735),r=e.i(65808),a=e.i(49061),s=e.i(78278),n=e.i(61542),i=e.i(14480),o=e.i(24769),d=e.i(53318),l=e.i(24259),u=e.i(4358),c=e.i(49400),p=e.i(47960),m=e.i(21467),f=e.i(25528),h=e.i(96010),w=e.i(64419),_=e.i(93695);e.i(21818);var g=e.i(2347),y=e.i(68105);e.i(81579);var A=e.i(95238),v=e.i(96391),I=e.i(21143),R=e.i(80956);async function S(e,t){try{let r=await (0,y.getCurrentUser)(e),{encryptedBlob:a}=t,s=function(e){if(!("object"==typeof e&&null!==e&&"string"==typeof e.encryptedData&&"string"==typeof e.iv&&"string"==typeof e.salt&&"string"==typeof e.authTag&&e.encryptedData.length>0&&e.iv.length>0&&e.salt.length>0&&e.authTag.length>0))return{isValid:!1,error:"Invalid encrypted data structure"};try{atob(e.encryptedData),atob(e.iv),atob(e.salt),atob(e.authTag);let t=Uint8Array.from(atob(e.iv),e=>e.charCodeAt(0)),r=Uint8Array.from(atob(e.salt),e=>e.charCodeAt(0)),a=Uint8Array.from(atob(e.authTag),e=>e.charCodeAt(0));if(12!==t.length)return{isValid:!1,error:"Invalid IV length"};if(16!==r.length)return{isValid:!1,error:"Invalid salt length"};if(16!==a.length)return{isValid:!1,error:"Invalid authentication tag length"};return{isValid:!0}}catch(e){return{isValid:!1,error:"Invalid base64 encoding"}}}(a);if(!s.isValid)return(0,v.createSecureErrorResponse)(`Invalid encrypted data: ${s.error}`,400,"INVALID_ENCRYPTED_DATA");if(a.encryptedData.length<16)return(0,v.createSecureErrorResponse)("Encrypted data appears to be too short",400,"SUSPICIOUS_ENCRYPTED_DATA");let n=`${a.encryptedData}${a.iv}${a.salt}${a.authTag}`;for(let e of[/<script/i,/javascript:/i,/data:text\/html/i,/vbscript:/i])if(e.test(n))return(0,v.createSecureErrorResponse)("Suspicious content detected in encrypted data",400,"SUSPICIOUS_CONTENT");let i=await A.prisma.vaultNote.create({data:{userId:r.id,encryptedBlob:JSON.stringify(a)}});return(0,v.createSecureSuccessResponse)({ok:!0,id:i.id,createdAt:i.createdAt.toISOString()})}catch(e){return console.error("[v0] Create vault note error:",e),(0,v.createSecureErrorResponse)("Failed to create vault note",500)}}let b=(0,I.withValidationAndRateLimit)(R.CreateVaultNoteSchema,I.RATE_LIMITS.VAULT_OPERATIONS,S);e.s(["POST",0,b],82708);var E=e.i(82708);let x=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/vault/create/route",pathname:"/api/vault/create",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/vault/create/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:C,workUnitAsyncStorage:k,serverHooks:T}=x;function O(){return(0,a.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:k})}async function q(e,t,a){x.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/vault/create/route";y=y.replace(/\/index$/,"")||"/";let A=await x.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!A)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:I,nextConfig:R,parsedUrl:S,isDraftMode:b,prerenderManifest:E,routerServerContext:C,isOnDemandRevalidate:k,revalidateOnlyGenerated:T,resolvedPathname:O,clientReferenceManifest:q,serverActionsManifest:N}=A,P=(0,d.normalizeAppPath)(y),D=!!(E.dynamicRoutes[P]||E.routes[O]),j=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,S,!1):t.end("This page could not be found"),null);if(D&&!b){let e=!!E.routes[O],t=E.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await j();throw new _.NoFallbackError}}let U=null;!D||x.isDev||b||(U="/index"===(U=O)?"/":U);let M=!0===x.isDev||!D,$=D&&!M;N&&q&&(0,i.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:q,serverActionsManifest:N,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:N})});let L=e.method||"GET",V=(0,n.getTracer)(),B=V.getActiveScopeSpan(),H={params:I,prerenderManifest:E,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>x.onRequestError(e,t,a,C)},sharedContext:{buildId:v}},F=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),X=u.NextRequestAdapter.fromNodeNextRequest(F,(0,u.signalFromNodeResponse)(t));try{let i=async e=>x.handle(X,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=V.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${L} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${y}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var n,d;let l=async({previousCacheEntry:r})=>{try{if(!o&&k&&T&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(s);e.fetchMetrics=H.renderOpts.fetchMetrics;let d=H.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let l=H.renderOpts.collectedTags;if(!D)return await (0,m.sendResponse)(F,K,n,H.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[w.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,a=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:k})},C),t}},u=await x.handleResponse({req:e,nextConfig:R,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:T,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:o});if(!D)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",k?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&D||c.delete(w.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(F,K,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};B?await d(B):await V.withPropagatedContext(e.headers,()=>V.trace(c.BaseServerSpan.handleRequest,{spanName:`${L} ${y}`,kind:n.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},d))}catch(t){if(t instanceof _.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:k})}),D)throw t;return await (0,m.sendResponse)(F,K,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>O,"routeModule",()=>x,"serverHooks",()=>T,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>k],87515)},90447,e=>{e.v(e=>Promise.resolve().then(()=>e(24710)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__39e01ba2._.js.map